<!DOCTYPE html>
<html>
<!--
　　　　　　　　  　　　/ヽ　　　　　　/ヽ
　　　　　　 　　 　　/ 　ヽ　　　 　 / 　ヽ
　   　＿＿＿＿＿＿ / 　 　 ヽ＿＿/　 　 　ヽ
　   　|　＿＿＿＿／　　　 　 　 　　   :::::::::＼
  　　| |　　　　 / ／　　　　　　＼ 　 　::::::::::::|
　 　| |　QQ　　　| （ ●）　　　 （●）  　 ::::::::::::|
　　| |191965461 |　 　　　 　　　　  　:::::::::::::|    本人一代码菜逼
　　| |　　　　 　|　 　（__人__丿   　.....:::::::::::::/   1998生
   | |＿＿＿＿　ヽ　　　　　    .....::::::::::::::::::::<    宅
　 └＿＿＿／￣￣　　　　　　    　:::::::::::::::::::::::::|  欢迎勾搭
　　|＼　　　 |　　　　　　　　　　　　:::::::::::::::::::::|
　　＼ ＼　　＼＿＿＿　　　　 　　 ::::::::::::::::::::::::|

-->
<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
    
    
    <title>MYSQL| MYSQL优化思路+知识点梳理 | 🎉 Missionary&#39;s Blog 😆 | Missionary 中国 👋</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta name="keywords" content="技术,原理,MYSQL,优化">
    <link rel="shortcut icon" href="/img/favicon.ico">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.2/dist/jquery.fancybox.min.css">
    <link rel="stylesheet" href="/css/style.css?v=1.4.4">

    
        <link rel="stylesheet" href="/css/third-party/gitment.css?v=1.4.4">
    
    <script type="text/javascript">
        // Data Center
        var DC = {
            reward:	true,
            lv: JSON.parse('{"enable":false,"app_id":"7yVfPXhFH02yrjkOWJ2agpo6-gzGzoHsz","app_key":"CGsuOukhiIkc4nE75fKtUtXy","icon":true}'),
            v: JSON.parse('{"enable":true,"appid":"7yVfPXhFH02yrjkOWJ2agpo6-gzGzoHsz","appkey":"CGsuOukhiIkc4nE75fKtUtXy","notify":true,"verify":true,"placeholder":"give me some sugers plz...","avatar":"wavatar","highlight":true}'),
            g: JSON.parse('{"enable":true,"lazy":true,"owner":"missionOdd","repo":"FAQ","oauth":{"client_id":"3dffefee0452a0a23205","client_secret":"1b1394230850e312a0a178bdd41c4e70893d759f"},"perPage":6}'),
            d: JSON.parse('{"app_id":"8997440a"}')
        };
    </script>
    <script type="text/javascript">
        window.lazyScripts=[];
    </script>
    
        <script type="text/javascript" src="/js/plugins/daovoice.js?v=1.4.4"></script>
    

<link rel="alternate" href="/atom.xml" title="🎉 Missionary's Blog 😆" type="application/atom+xml">
</head>

<script src="//cdnjs.cat.net/ajax/libs/pace/1.0.2/pace.min.js"></script>
<link href="//cdnjs.cat.net/ajax/libs/pace/1.0.2/themes/pink/pace-theme-flash.css" rel="stylesheet">
<link rel="stylesheet" href="//cdnjs.loli.net/ajax/libs/mdui/0.4.1/css/mdui.min.css">
<link rel="stylesheet"  href="//cdnjs.cat.net/ajax/libs/animate.css/3.5.2/animate.min.css">
<link rel="stylesheet" href="/css/custom.css?v=1.4.4">
<link href="//cdnjs.cat.net/ajax/libs/photoswipe/4.1.2/photoswipe.css" rel="stylesheet">
<link href="//cdnjs.cat.net/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.css" rel="stylesheet">

<body>
    <div id="loading" class="active mdui-progress">
  <div class="mdui-progress-determinate"></div>
</div>

    <aside id="menu" class="">
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-close"></i>
    </a>
    <div class="brand-wrap">
      
      <img src="/img/brand.jpg" class="brand-bg">
      
      <div class="brand">
        <a href="/" class="avatar waves-effect waves-circle waves-light rubberBand ">
          <img src="/img/avatar.jpg">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname">Missionary</h5>
          <a href="mailto:z1165996866@hotmail.com" title="z1165996866@hotmail.com" class="mail">
            
              <span>z</span>
            
              <span>1</span>
            
              <span>1</span>
            
              <span>6</span>
            
              <span>5</span>
            
              <span>9</span>
            
              <span>9</span>
            
              <span>6</span>
            
              <span>8</span>
            
              <span>6</span>
            
              <span>6</span>
            
              <span>@</span>
            
              <span>h</span>
            
              <span>o</span>
            
              <span>t</span>
            
              <span>m</span>
            
              <span>a</span>
            
              <span>i</span>
            
              <span>l</span>
            
              <span>.</span>
            
              <span>c</span>
            
              <span>o</span>
            
              <span>m</span>
            
          </a>
          <a href="/atom.xml" rel="alternate" class="mdui-btn mdui-btn-dense mdui-color-theme-accent mdui-ripple">
              <i class="fa fa-rss"></i>
              RSS订阅
            </a>
        </hgroup>
        
        <ul class="menu-link">
          
              <li>
                <a href="https://github.com/missionOdd" target="_blank">
                  <i class="icon icon-lg icon-github"></i>
                </a>
              </li>
            
              <li>
                <a href="https://leetcode-cn.com/u/missionary" target="_blank">
                  <i class="icon icon-lg icon-gg-circle"></i>
                </a>
              </li>
            
        </ul>
        
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="">
              <a href="/" >
                <i class="icon icon-lg icon-home"></i>
                HOME
              </a>
            </li>
        
            <li class="">
              <a href="/photos" >
                <i class="icon icon-lg icon-camera"></i>
                PHOTOS
              </a>
            </li>
        
            <li class="">
              <a href="/books" >
                <i class="icon icon-lg icon-book"></i>
                BOOKS
              </a>
            </li>
        
            <li class="">
              <a href="/categories" >
                <i class="icon icon-lg icon-th-list"></i>
                CATEGORIES
              </a>
            </li>
        
            <li class="">
              <a href="/tags" >
                <i class="icon icon-lg icon-tags"></i>
                TAGS
              </a>
            </li>
        
            <li class="">
              <a href="/archives" >
                <i class="icon icon-lg icon-archives"></i>
                ARCHIVES
              </a>
            </li>
        
            <li class="">
              <a href="/about" >
                <i class="icon icon-lg icon-user"></i>
                ABOUT
              </a>
            </li>
        
            <li class="">
              <a href="https://github.com/missionOdd" target="_blank">
                <i class="icon icon-lg icon-github"></i>
                GITHUB
              </a>
            </li>
        
            <li class="">
              <a href="https://leetcode-cn.com/u/missionary/" target="_blank">
                <i class="icon icon-lg icon-gg-circle"></i>
                LEETCODE
              </a>
            </li>
        
            <li class="">
              <a href="http://weibo.com/missionodd" target="_blank">
                <i class="icon icon-lg icon-weibo"></i>
                WEIBO
              </a>
            </li>
        
            <li class="">
              <a href="/custom" >
                <i class="icon icon-lg icon-plus-square"></i>
                LINKS
              </a>
            </li>
        
      </ul>
    </div>
  </div>
</aside>

    <main id="main">
        <header class="top-header" id="header">
    <div class="flex-row clearfix">
        <a href="javascript:;" class="header-icon pull-left waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">
            <span>MYSQL| MYSQL优化思路+知识点梳理</span>
            
        </div>
        
        <a href="javascript:;" id="site_search_btn" class="header-icon pull-right waves-effect waves-circle waves-light">
            <i class="icon icon-lg icon-search"></i>
        </a>
        
    </div>
</header>
<header class="content-header post-header">
    <img src="/img/banner.jpg" class="header-bg">
    <div class="container fade-scale">
        <h1 class="title animated tada delay-5s">MYSQL| MYSQL优化思路+知识点梳理</h1>
        <h5 class="subtitle animated swing delay-5s">
            
                <time datetime="2022-02-14T05:50:37.000Z" itemprop="datePublished" class="page-time">
  2022-02-14
</time>


	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/技术/">技术</a><ul class="article-category-list-child"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/技术/中间件/">中间件</a></li></ul></li></ul>


            
        </h5>
        
    </div>
    

</header>

<div id="site_search">
    <div class="search-title clearfix">
        <span class="pull-left">
          <i class="icon icon-lg icon-search"></i>
        </span>
        <input type="text" id="local-search-input" name="q" results="0" placeholder="search my blog..." class="form-control pull-left"/>
        <a href="javascript:;" class="close pull-right waves-effect waves-circle waves-light">
          <i class="icon icon-lg icon-close"></i>
        </a>
    </div>
    <div id="local-search-result"></div>
</div>



<div class="container body-wrap">
    <article id="post-mysql-notes"
  class="post-article article-type-post" itemprop="blogPost">
    <div class="post-card">
        <h1 class="post-card-title">MYSQL| MYSQL优化思路+知识点梳理</h1>
        <div class="post-meta">
          
            <time class="post-time" title="2022-02-14 13:50:37" datetime="2022-02-14T05:50:37.000Z"  itemprop="datePublished">2022-02-14</time>

            
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/技术/">技术</a><ul class="article-category-list-child"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/技术/中间件/">中间件</a></li></ul></li></ul>



            

            
<span class="post-comments-counter" id="/2022/02/14/mysql-notes/">
    <span class="post-meta-item-icon">
        <i class="icon icon-comment-o"></i>
    </span>
    
    <a href="/2022/02/14/mysql-notes/#gitment-display-button" onclick="ShowGitment()">
        <span class="post-comments-count gitment-comments-count" itemprop="commentsCount"></span>
    </a>
</span>



    <span class="leancloud-comment">
        <i class="icon icon-comment-o"></i>
        <a href="/2022/02/14/mysql-notes/#comment">
            <span class="valine-comment-count" data-xid="/2022/02/14/mysql-notes/"></span>
        </a>
    </span>


            
        </div>
        <div class="post-content" id="post-content" itemprop="postContent">
            
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>多数来自王校长MYSQL系列<br>笔记优点：从调优角度去挖知识</p>
<h2 id="索引"><a href="#索引" class="headerlink" title="索引"></a>索引</h2><p>调优为主线，进行贯穿，再引申。<br>从mysql初期设计表开始考虑调优，<strong>控制单行数据的大小</strong>。<br>不能像初学者，直接来一个varchar(255)，过于浪费空间。<br>varchar不像char定长，它首先额外存储1或2字节的长度，再存储一个变长的数据。<br>存储就不得不讲B+树。</p>
<p><strong>B+树是mysql索引数据的存储数据结构</strong>。<br>先以<strong>聚簇索引</strong>为例，以主键进行索引树，非叶子存储索引，叶子存储整行的数据，比如bigint类型自增，除了存储本身8字节整型，还加上一个6字节的向下指针，对于bigint类型主键，非叶子节点的每一条数据需要至少占用14字节，（tips：B-是开区间）比如，ID 1，真正的节点存储格式80 00 00 01，ID 3 为80 00 00 03，这是8字节，指针来说，是6字节。根节点是16kb的内存页，16kb*1024/14约等于1170索引数据，第二层有1170节点，每个节点有1170个ID+指针，那么，第三层就是1170^2，大概1百万叶子节点，叶子节点存储的是所有数据。<br>那么，如果1条mysql数据，没有好好规划它的大小。如果1行有16kb，那么mysql只能存储1百万条数据，就是1个内存页只有1行数据，这是非常恐怖。如果是1行1kb ，那么，1个内存页存储16行，那么，1百多万乘16，可以存储1千6百万，差不多2千万条数据。</p>
<p>这里，3层B+树出现一个3次IO索引。每次IO索引时间复杂度O(logn)其实就是用了二分查找，这是B+树查询快的原因之一。刚刚讲到，有一个内存页1行数据的IO，这查效率是相对慢，这就涉及到加载内存页的问题，16kb内存页加载出来，这算1次IO。首先，一层16kb内存页加载完成后，再进行二分查找，定位ID范围，然后指向二层，此时，又要加载16kb内存页，在这里边，又要定位ID范围去加载第三层，三层又要加载16kb内存页，再二分查找最终定位数据。当然，1和2层一般回缓存预热，减少查询IO。但是，如果1行16kb，查询多行，IO次数依然较大。<br>控制1行数据大小，这就是B+树的<strong>高扇出性</strong>。</p>
<p>为什么不用二叉树？不用hash表？B树也不怎么用？<br>B树，<strong>每一个节点都要存储数据</strong>。从根节点开始存储数据，这时候，如果1kb数据，最多15条，再加上16指针，指向16个二层节点，二层节点又16个指针，三层就大概是16的平方，369个叶子。三层B树，撑死就这么多。如果2千万条数据，那么mysql一直IO内存页，再二分查找，非常要命。<br>二叉树呢，原因一样。B树起码是个多叉树，还不如B树。<br>那HashMap呢，在不冲突情况是O(1)，而树的索引，查询是O(logn)。为什么不用hash表？<br>第一点，<strong>不支持模糊查询</strong>，也没有最左匹配原则<br>第二点，<strong>不支持范围查询</strong>，一个个离散hash，太恐怖了。<br>第三点，hash冲突不可避免。</p>
<p>为什么不用跳表？<br>跳表是一种链表的优化，查询O(logn)。<br>主要是mysql的存储介质是磁盘，链式结构是存放内存。<br>mysql数据是块形式，是16kb内存页，在内存页定位数据。链表是一个个node节点，节点只有1条数据，磁盘IO更多，而且磁盘无法对链表预读。<br>B+树数据分布更均匀，每一条查询速度一样，更平衡稳定。<br>跳表数据分布不均匀，查询数据经过路径长度是不一样的。</p>
<p>B+树有一个最左前缀原则<br>能够支持模糊查询，比如查找同姓的，王1，王2，王3直接遍历叶子内存页；<br>能够支持范围查询，比如查找ID范围，从1到100直接遍历叶子内存页；</p>
<p><strong>聚簇索引</strong>，是每一张表都有的主键ID<br><strong>辅助索引</strong>，是自己设的索引，每个辅助索引都有一棵叶子是索引值+主键的树  </p>
<p><strong>联合索引</strong>，多个字段连起来的索引，如果没有主键ID，可以是辅助索引；</p>
<p>如何在表里边定义索引？<br>要看字段的随机度，随机度越高，定义为索引的索引效率越高。<br>举个反例，如果存储1000万人，性别只有男女，也就是只有01两种情况，这个字段定位性太差，一下子定位到差不多500万的范围，建议不加，因为加索引优化不大，而且还会增加插入数据时的一个索引负担。<br>如果是日期，随机性很高了，怎么看离散呢，命令show index，然后看cardinality（扣低内了体）的值，接近1，说明离散越高，就适合索引。当然，这最终还是对应我们的业务 来说。</p>
<p>cardinality的值，多说一下，它是通过采样算法，会实时变化的。</p>
<p><strong>覆盖索引</strong>，它其实不是索引，它是一种效果，没有树，指查询无需回表的索引。关键在于select的字段，是否都在辅助索引的叶子中。如果是select * ，那它回经历辅助索引三层，然后聚簇索引三层<br>，这个过程就是回表，发送了6次IO，差距就上来了。</p>
<p>索引前缀：把文本前缀作为索引，增加长文本查询效率。</p>
<h3 id="Q：什么情况索引失效？"><a href="#Q：什么情况索引失效？" class="headerlink" title="Q：什么情况索引失效？"></a>Q：什么情况索引失效？</h3><p>记忆：LOL+-*/ not null  function convert join<br>Like  不匹配最左前缀的模糊查询，比如，以%开头<br>Or    不匹配最左前缀的Or，or作为condition的连接符，当前后两个条件都是索引不失效，但凡有一个不为索引就会失效。</p>
<p>Lian联合查询，不匹配最左前缀的and联合查询，ab联合索引，如果不以a为首部作为查询，就会索引失效。</p>
<p>+-*/ 条件字段加减乘除计算，索引失效，比如，age年龄-1=10，失效。</p>
<p>not 非不等于，!=，&lt;&gt;，is not，取反集就会失效。</p>
<p>null 字段is null 和 is not null，不一定失效，索引允许null，但是B+树索引不会存有bull值，比如 age is not null，可以走索引，而且还有优化器可优化。为避免失效，字段尽可能设置not null，如果需表示null，尽量设默认值，使索引完全能够构建到B+树。</p>
<p>function 对字段使用内置函数，比如dateadd(propName, -1) =2022.1.28，失效。</p>
<p>convert 字段转换，比如：员工ID是varchar类型，查询用了 id = 12345，这就发生varchar转int，因此，要加上单引号。</p>
<p>join 连表看情况，如果id类型不一样，那就会失效。</p>
<p>我是就是我，不一样的版本不一样的我。</p>
<p>select * from table where A&gt;3。A是辅助索引。<br>mysql5.5，一般是全表扫描，不会用A辅助索引，三次IO。这里考虑了离散读的问题，从辅助索引三次IO，拿到所有ID，再从聚簇索引发生超过三次IO拿数据，至少6次IO，有特别离散的5个ID，就有3 + 1+5+5=11次IO。<br>它有一个阈值衡量，比如小于20w数据或小于总量一半，辅助索引失效，聚集索引进行一次三次IO之后，从叶子全表扫描。大于20W数据，利用辅助索引进行离散读。</p>
<p>mysql5.6+，引入<strong>MRR优化</strong>，解决离散读。立马辅助索引3次IO找ID，存入缓存后排序，再进入聚集索引。如果ID间隔不大，就进行叶子顺序扫描，如果ID间隔大，就二分查找。<br>顺序磁盘IO，比随机IO，可能提高10倍。</p>
<p>在计算机中，随机io的速度比顺序的io的速度慢很多，因为在一个柱面中，随机io必然会造成磁头的随机旋转，从而产生一定量的磁盘io，而顺序io则可降低到最低。</p>
<figure class="image-box">
                <a rel=MYSQL| MYSQL优化思路+知识点梳理 href="6E93E449-CEDB-431F-9F78-ADB219D3FC91_20220303211957.png?v=1&type=image&token=V1:geO33iNjY-_a2JB32jzPvAkcUhKneA_8zPt3utACWRg" title="输入图片描述" data-fancybox="images"><img src="6E93E449-CEDB-431F-9F78-ADB219D3FC91_20220303211957.png?v=1&type=image&token=V1:geO33iNjY-_a2JB32jzPvAkcUhKneA_8zPt3utACWRg" alt="输入图片描述" title class></a>
                <p>输入图片描述</p>
            </figure>
<p>索引下推：先在辅助索引过滤掉所有能够过滤的，再一次回表。</p>
<h2 id="Mysql锁"><a href="#Mysql锁" class="headerlink" title="Mysql锁"></a>Mysql锁</h2><h3 id="MVCC概念"><a href="#MVCC概念" class="headerlink" title="MVCC概念"></a>MVCC概念</h3><p>一致性非锁定读，也叫多版本并发控制。<br>一句话，基于自己的回滚机制，为并发场景读的优化，为了达到读操作不需要被锁定的效果，加快mysql读取。<br>底层基于undo log回滚日志和一致性视图。<br>接下来，讲一下mysql不同隔离级别的MVCC表现。<br>从低到高分别是 read uncommitted读未提交，read committed 读已提交，repeatable read可重复读，串行化读。<br>默认是可重复读。<br>已三条线程来举例子，A，B修改线程，C读线程。</p>
<p>A，C同时对1条数据读写，C开启事务，A去修改，A在修改前生成一版快照，就是undo log，A修改完成，并且提交。目前又两个版本，B又对数据改，又对生成一版快照提交，此时有三个版本。<br>C线程再读，C线程访问哪部分？<br>在可重复读情况：<br>C读的是最原始版本。</p>
<p>在读已提交情况：<br>C读的是最新B提交的版本。</p>
<p>在读未提交情况：<br>A线程改，生成版本undo log 后，未提交。<br>C读的是未提交的A中间状态的数据。<br>这是无所谓版本控制了，是一种即时读取。<br>读取没有持久化的脏数据，是脏读。</p>
<p>在串行化情况：<br>理解为无论读写操作，都会锁表，操作是严格串行，无所谓版本控制。</p>
<p>读已提交，事务隔离了吗？<br>没有隔离，AB的修改，影响了C的读取，违背了事务隔离性。</p>
<p>那么，可重复读，C的读不会收到其他事务影响，实现事务的隔离性。</p>
<p>对于读未提交，没有持久化的中间状态的脏数据也能读取，这就是脏读。<br>现在我们几乎不会碰到脏读，除非，隔离级别改为读未提交。</p>
<p>对于读已提交，如果C一个事务中在A修改前后读取两次，发现两次读取结果不一样，这就是不可重复读。<br>如果A改为删除，C一个事务中在A删除前后的读取两次，发现第二次读不了，这就幻读。</p>
<p>我认为，不可重复和幻读本质相邻。</p>
<p>对于重复读，通过行锁解决不可重读，再配合间隙锁解决幻读。</p>
<p>对于串行化，用表锁，不会出现以上问题。</p>
<h3 id="锁"><a href="#锁" class="headerlink" title="锁"></a>锁</h3><p>一种是锁本条记录，一种是锁范围。<br>共享锁：事务共享读。<br>排他锁：限制一个事务改<br>多个事务能同时获得某一行的共享税，这叫锁兼容。<br>若事务需要获得某一行的排他锁，就要等待所有共享锁及排他锁的释放，这是锁不兼容。</p>
<p>InnoDB有三种行锁的算法：<br>Record Lock：普通的单个行锁，总会锁住索引记录，如果没有索引，就会锁隐式主。</p>
<p>Gap Lock 间隙锁，锁一个范围，不包括记录本身。<br>next-key lock：左右两边的GAP Lock + Record Lock，锁一个包括本身的范围，对于行查询都采用这种方式。</p>
<p>InnoDB的[next-key lock]本身的设计方案就是左开右闭的，例如</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from t where c2 = 10 for update;</span><br></pre></td></tr></table></figure>
<p>next-key lock则锁定的是 c2=10 这条记录本身，以及其[索引节点]上 c2=10 前面的那个gap。</p>
<p>但在RR隔离级别中，为了避免发生幻读，需要把所有可能插入 c2=10 这个值的位置都加上锁，所以对 c2 =10 后面的gap也会加锁。</p>
<p>当查询的索引含有唯一标识属时，Next key Lock 会降级为Record Lock，仅锁本身。</p>
<p>索引上的等值查询，未命中，所在的Net-Key Lock，退化为GAP Lock 。</p>
<h2 id="日志系统"><a href="#日志系统" class="headerlink" title="日志系统"></a>日志系统</h2><p> 从插入场景开始讲，<br> mysql 插入会 记录持久化日志redolog，如果mysql非常高并发插入，会有什么性能瓶颈？<br> 首先，面临最大的性能瓶颈，就是ID自增长。ID不重复，就是数据安全，说明有锁，就涉及到block阻塞。<br> 5.1.22之前，所有插入有个auto increase locking，它是一个轻量级锁，innodb提供了是自增长计数器，它是保证计数器线程安全。插入sql提交前进行锁的释放，他不需要等事务提交后才锁释放，这算提高mysql性能：事务提交涉及到mysql持久化的问题，一旦持久化，就要消耗磁盘写入的时间，如果提交后才释放，就是要等待加上持久化时间。5.1.22之后，把id子增长，调整为三种模式。一种是原始的轻量级锁，二是默认策略，分两种情况：如果已知插入数据数量，比如10条，采用了更轻量的互斥量，如果自增长计数器是0，可知最终是10，只需要把1-10分配给10条数据，中间无需block阻塞。对于未知的插入数量，则采用原始的一插入一block的方式；三是无论如何都用互斥量，这会导致ID不连续，将威胁到mysql主从同步问题，不同节点ID不一样了。如果不考虑主从同步，可以用。</p>
<p>主从同步，有两个策略 ：一是rbr，row形式，记录每一行最后更变样子的语句，二是sbr，statement形式。如果用statement，会记录插入语句，那么在从服务器，执行未知插入数量的语句，互斥量形式插入，ID不连续，可能ID不一致。</p>
<p>在持久化redo log之前，会存入redobuff log 一个缓冲型日志，在commit时才会fsync磁盘刷新，flush同步到磁盘，然后最终到磁盘。</p>
<p>问题来了，1000万条每一commit一次造成刷盘，有性能问题，也会影响磁盘寿命。这个盘刷其实做了3种策略：一是每次提交刷盘，这是最好的，二是每一秒定期刷盘，是执行sql语句的线程在做，相当于1000万条只有一次刷盘，有一定延迟，可能存在数据丢失；<br>三是从不刷新，没有redo log，宕机就无法恢复。</p>
<p>redo log 记录的是内存页的实际数据，bin log 只是语句层面的数据，它不是用于恢复逻辑。</p>
<p>我们最好是在代码层面，将多条数据变成同一条语句进行插入，一次性提交。如果数据过大，可以分批batch每2000条插入。这样commit的量小，性能提升可达10倍以上，因为盘刷有性能瓶颈，磁盘1秒撑不住1千次刷。</p>
<p>binlog，用于主从数据同步，包括pit同步。</p>
<p>undo log，有两个功能，一个是回滚，有个undo段，理解为有几个阶段的回滚快照，以实现MVCC。</p>
<p>总结<br>MVCC结合undo来说，以及不同事物级别的表现，提到redo log，结合mysql插入性能，就要联系ID自增和提交刷盘。</p>
<hr>
<h2 id="其他的问题"><a href="#其他的问题" class="headerlink" title="其他的问题"></a>其他的问题</h2><h3 id="Q：执行计划？"><a href="#Q：执行计划？" class="headerlink" title="Q：执行计划？"></a>Q：执行计划？</h3><p>我们一一来介绍,并说明每个属性有哪些可选值,以及每个可选值的意思。</p>
<ul>
<li><p>id: 表示查询中select操作表的顺序,按顺序从大到依次执行</p>
</li>
<li><p>select_type :<br>该表示选择的类型,常见可选值有: SIMPLE(简单的), PRIMARY(最外层) ，SUBQUERY(子查询中的第一个select查询)</p>
</li>
<li><p>type :<br>该属性表示访问类型,有很多种访问类型。<br>最常见的其中包括以下几种: ALL(全表扫描), index(索引扫描),range(范围扫描),ref (非唯一索引扫描),eq_ref(唯一索引扫描,),(const)常数引用, 访问速度依次由慢到快。</p>
<p>其中 : range(范围)常见与 between and …, 大于 and 小于这种情况。<br>提示 : 慢SQL是否走索引,走了什么索引,也就可以通过该属性查看了。</p>
</li>
<li><p>table :<br>表示输出行数据所在表</p>
</li>
<li><p>possible_keys :<br>顾名思义,该属性给出了,该查询语句,可能走的索引,(如某些字段上索引的名字)这里提供的只是参考,而不是实际走的索引,也就导致会有possible_Keys不为null,key为空的现象。</p>
</li>
<li><p>key : 显示MySQL实际使用的索引,其中就包括主键索引(PRIMARY),或者自建索引的名字。</p>
</li>
<li><p>key_len : 表示索引所使用的字节数，</p>
</li>
<li><p>ref :<br>连接匹配条件,如果走主键索引的话,该值为: const, 全表扫描的话,为null值</p>
</li>
<li><p>rows :<br>扫描行数,也就是说，需要扫描多少行,采能获取目标行数,一般情况下会大于返回行数。通常情况下,rows越小,效率越高, 大部分SQL优化，都是在减少这个值的大小。</p>
<p>注意: 理想情况下扫描的行数与实际返回行数理论上是一致的,但这种情况及其少,如关联查询,扫描的行数就会比返回行数大大增加)</p>
</li>
<li><p>Extra 这个属性非常重要,该属性中包括执行SQL时的真实情况信息,如上面所属,使用到的是”using where”，表示使用where筛选得到的值,常用的有: “Using temporary”: 使用临时表 “using filesort”: 使用文件排序</p>
</li>
</ul>
<p>Q：为什么要做主从同步？</p>
<ol>
<li>读写分离，使数据库能支撑更大的并发。</li>
<li>在主服务器上生成实时数据，而在从服务器上分析这些数据，从而提高主服务器的性能。</li>
<li>数据备份，保证数据的安全。</li>
</ol>
<p>Q: 用过processlist吗？<br>show processlist 或 show full processlist 可以查看当前 MySQL 是否有压力，正在运行的 sql，有没有慢 SQL 正在执行。</p>
<p>Q: 讲一下MySQL架构？<br>MySQL主要分为 Server 层和存储引擎层：<br> <strong>Server 层</strong>：主要包括连接器、查询缓存、分析器、优化器、执行器等，所有跨存储引擎的功能都 在这一层实现，比如存储过程、触发器、视图，函数等，还有一个通用的日志模块 binglog 日志模 块。<br> <strong>存储引擎</strong>： 主要负责数据的存储和读取。 server 层通过api与存储引擎进行通信。<br> Server 层基本组件<br> <strong>连接器</strong>：<br>当客户端连接 MySQL 时，server层会对其进行身份认证和权限校验。<br> <strong>查询缓存</strong>:<br> 执行查询语句的时候，会先查询缓存，先校验这个 sql 是否执行过，如果有缓存这个 sql，就会直接返回给客户端，如果没有命中，就会执行后续的操作。<br> <strong>分析器</strong>:<br> 没有命中缓存的话，SQL 语句就会经过分析器，主要分为两步，词法分析和语法分析，先 看 SQL 语句要做什么，再检查 SQL 语句语法是否正确。<br> <strong>优化器</strong>：<br>   优化器对查询进行优化，包括重写查询、决定表的读写顺序以及选择合适的索引等，生成 执行计划。<br>  <strong>执行器</strong>：<br>   首先执行前会校验该用户有没有权限，如果没有权限，就会返回错误信息，如果有权限， 就会根据执行计划去调用引擎的接口，返回结果。</p>
<h3 id="Q：大表怎么优化？"><a href="#Q：大表怎么优化？" class="headerlink" title="Q：大表怎么优化？"></a>Q：大表怎么优化？</h3><p> 某个表有近千万数据，查询比较慢，如何优化？<br> 当MySQL单表记录数过大时，数据库的性能会明显下降，一些常见的优化措施如下： <strong>限定数据的范围</strong>。比如：用户在查询历史信息的时候，可以控制在一个月的时间范围内； <strong>读写分离</strong>： 经典的数据库拆分方案，主库负责写，从库负责读； 通过分库分表的方式进行优化，主要有<strong>垂直拆分</strong>和<strong>水平拆分</strong>。</p>
<h3 id="Q-一条语句的执行过程？"><a href="#Q-一条语句的执行过程？" class="headerlink" title="Q:一条语句的执行过程？"></a><strong>Q:一条语句的执行过程？</strong></h3><p><strong>查询语句：</strong></p>
<ul>
<li><p>先检查该语句是否有权限，如果没有权限，直接返回错误信息，如果有权限，在 MySQL8.0 版本以前，会先查询缓存，以这条 sql 语句为 key 在内存中查询是否有结果，如果有直接缓存，如果没有，执行下一步。</p>
</li>
<li><p>通过分析器进行词法分析，提取 sql 语句的关键元素，比如提取上面这个语句是查询 select，提取需要查询的表名为 tb_student，需要查询所有的列，查询条件是这个表的 id=’1’。然后判断这个 sql 语句是否有语法错误，比如关键词是否正确等等，如果检查没问题就执行下一步。</p>
</li>
<li><p>接下来就是优化器进行确定执行方案，上面的 sql 语句，可以有两种执行方案：</p>
<p><code>a.先查询学生表中姓名为“张三”的学生，然后判断是否年龄是</code> <code>18`</code>。`</p>
<p><code>b.先找出学生中年龄</code> <code>18</code> <code>岁的学生，然后再查询姓名为“张三”的学生。</code></p>
<p>那么优化器根据自己的优化[算法]进行选择执行效率最好的一个方案（优化器认为，有时候不一定最好）。那么确认了执行计划后就准备开始执行了。</p>
</li>
<li><p>进行权限校验，如果没有权限就会返回错误信息，如果有权限就会调用数据库引擎接口，返回引擎的执行结果。</p>
</li>
<li><p>更新语句执行过程</p>
</li>
<li><p>更新语句执行流程如下：分析器、权限校验、执行器、引擎、redo log(prepare 状态)、binlog、redo log(commit状态)</p>
<p>更新语句：</p>
<p>update user set name=’大彬’whereid = 1;</p>
<ol>
<li>先查询到 id 为1的记录，有缓存会使用缓存</li>
<li>拿到查询结果，将 name 更新为 大彬，然后调用引擎接口，写入更新数据，innodb 引擎将数据保存在内存中，同时记录 redo log，此时 redo log 进入 prepare 状态，然后告诉执行器，执行完成了，随时可以提交。</li>
<li>执行器收到通知后记录 binlog，然后调用引擎接口，提交 redo log 为提交状态。</li>
<li>更新完成。</li>
</ol>
</li>
</ul>
<h3 id="Q-：重做日志刷新到磁盘的策略有几种，有什么优劣？"><a href="#Q-：重做日志刷新到磁盘的策略有几种，有什么优劣？" class="headerlink" title="Q ：重做日志刷新到磁盘的策略有几种，有什么优劣？"></a>Q ：重做日志刷新到磁盘的策略有几种，有什么优劣？</h3><p>innodb_flush_log_at_trx_commit用来控制重做日志刷新到磁盘的策略。 n 该参数的默认值为1，表示事务提交时必须调用一次fsync操作。还可以设置该参数的值为0和2。 n 0表示事务提交时不进行写入重做日志操作，这个操作仅在master thread中完成，而在master thread中每1秒会进行 一次重做日志文件的fsync操作。 n 2表示事务提交时将重做日志写入重做日志文件，但仅写入文件系统的缓存中，不进行fsync操作。在这个设置下， 当MySQL数据库发生宕机而操作系统不发生宕机时，并不会导致事务的丢失。而当操作系统宕机时，重启数据库后 会丢失未从文件系统缓存刷新到重做日志文件那部分事务</p>
<p>举例： 插入50万条数。正确方法：innodb_flush_log_at_trx_commit = 1，将50万条数据在一个事务或者多个事务中分派提交，减少fsync次 数</p>
<h3 id="Q：purge-操作有什么作用-MySQL-篇-delete和update操作可能并不直接删除原有的数据。"><a href="#Q：purge-操作有什么作用-MySQL-篇-delete和update操作可能并不直接删除原有的数据。" class="headerlink" title="Q：purge 操作有什么作用 MySQL 篇 delete和update操作可能并不直接删除原有的数据。"></a>Q：purge 操作有什么作用 MySQL 篇 delete和update操作可能并不直接删除原有的数据。</h3><p>delete和update操作可能并不直接删除原有的数据。</p>
<p>例如， DELETE FROM t WHERE a=1; 表t上列a有聚集索引，列b上有辅助索引。对于上述的delete操作，仅是将主键列等于1的记录delete flag设 置为1，记录并没有被删除，即记录还是存在于B+树中。其次，对辅助索引上a等于1，b等于1的记录同样 没有做任何处理。而真正删除这行记录的操作其实被“延时”了，最终在purge操作中完成。 purge用于最终完成delete和update操作。这样设计是因为InnoDB存储引擎支持MVCC，所以记录不能在事 务提交时立即进行处理。这时其他事物可能正在引用这行，故InnoDB存储引擎需要保存记录之前的版本。 而是否可以删除该条记录通过purge来进行判断。若该行记录已不被任何其他事务引用，那么就可以进行真 正的delete操作。可见，purge操作是清理之前的delete和update操作，将上述操作“最终”完成。而实际执行 的操作为delete操作，清理之前行记录的版本。</p>
<h3 id="Q：说说主从复制的工作原理"><a href="#Q：说说主从复制的工作原理" class="headerlink" title="Q：说说主从复制的工作原理"></a>Q：说说主从复制的工作原理</h3><p>1）主服务器（master）把数据更改记录到二进制日志（binlog）中。</p>
<p> 2）从服务器（slave）把主服务器的二进制日志复制到自己的中继日志（relay log）中。</p>
<p> 3）从服务器重做中继日志中的日志，把更改应用到自己的数据库上，以达到数据的最终一致性</p>
<p>复制的工作原理并不复杂，其 实就是一个完全备份加上二进 制日志备份的还原。不同的是 这个二进制日志的还原操作基 本上实时在进行中。这里特别 需要注意的是，复制不是完全 实时地进行同步，而是异步实 时。这中间存在主从服务器之 间的执行延时，如果主服务器 的压力很大，则可能导致主从 服务器延时较大。</p>
<p>从服务器有2个线程，一个是I/O线程，负责读取主服务器的二进制日志，并将其保存为中继日志；另一个是SQL 线程，复制执行中继日志。</p>
<h3 id="Q：主从复制bin-log-日志有几种记录方式"><a href="#Q：主从复制bin-log-日志有几种记录方式" class="headerlink" title="Q：主从复制bin log 日志有几种记录方式"></a>Q：主从复制bin log 日志有几种记录方式</h3><p>变更操作将根据选定的格式类型写入 binlog 文 件，目前支持三种 format：</p>
<p> statement-based Replication（SBR） ：master将SQL statements语句写入binlog，slave 也将 statements 复制到本地执行；简单 而言，就是在 master 上执行的 SQL 变更语句，也同样在 slaves 上执行。SBR 模式是 MySQL 最早支持的类型，也是 Replication 默 认类型。</p>
<p>row-based Replication（RBR）： master将每行数据的变更信息写入binlog，每条 binlog 信息表示一行（row）数据的变更内容， 对于 slaves 而言将会复制 binlog 信息，然后单条或者批量执行变更操作；</p>
<p> mix-format Replication：混合模式，在这种模式下，master将根据根据存储引擎、变更操作类型等，从SBR、RBR中来选择更合 适的日志格式，默认为 SBR；具体选择那种格式，这取决于变更操作发生的存储引擎、statement 的类型以及特征，优先选择 “数 据一致性” 最好的方式（RBR），然后才兼顾性能，比如 statement 中含有 “不确定性” 方法或者批量变更，那么将选择 RBR 方式， 其他的将选择 SBR 以减少 binlog 的大小。我们建议使用 mix 方式。</p>
<p>SBR 和 RBR 都有各自的优缺点，对于大部分用而言，mix 方式在兼顾数据完整性和性能方面是最佳的选择</p>
<h3 id="Q：-主从复制有几种方式？"><a href="#Q：-主从复制有几种方式？" class="headerlink" title="Q： 主从复制有几种方式？"></a>Q： 主从复制有几种方式？</h3><p>异步复制</p>
<p>MySQL 默认的复制策 略，Master 处理事务过 程中，将其写入 Binlog 就会通知 Dump thread 线程处理，然后完成事 务的提交，不会关心是 否成功发送到任意一个 slave 中。</p>
<p>半同步复制</p>
<p>Master处理事务过程中，提交完事务后，必须 等至少一个 Slave 将收到的 binlog 写入 relay log 返回 ack 才能继续执行处理用户的事务。</p>
<p>增强半同步复制</p>
<p>强半同步和半同步不同是，等待 ACK 时 间不同 rpl_semi_sync_master_wait_point = AFTER_SYNC（唯一区别） 半同步的问题是因为等待 ACK 的点是 Commit 之后，此时 Master 已经完成数据 变更，用户已经可以看到最新数据，当 Binlog 还未同步到 Slave 时，发生主从切 换，那么此时从库是没有这个最新数据的， 用户又看到老数据。 增强半同步将等待 ACK 的点放在提交 Commit 之前，此时数据还未被提交，外 界看不到数据变更，此时如果发送主从切 换，新库依然还是老数据，不存在数据不 一致的问题。</p>
<h3 id="Q：Innodb-和-mylsam-存储引擎的区别"><a href="#Q：Innodb-和-mylsam-存储引擎的区别" class="headerlink" title="Q：Innodb 和 mylsam 存储引擎的区别"></a>Q：Innodb 和 mylsam 存储引擎的区别</h3><ol>
<li><p>是否支持行级锁 : MyISAM 只有表级锁 (table-level locking)，而 InnoDB 支持行级锁 (rowlevel locking) 和表级锁 , 默认为行级锁。</p>
</li>
<li><p>是否支持事务和崩溃后的安全恢复： MyISAM 强调的是性能，每次查询具有原子性 , 其执 行速度比 InnoDB 类型更快，但是不提供事务支持。但是 InnoDB 提供事务支持事务，外部 键等高级数据库功能。具有事务 (commit)、回滚 (rollback) 和崩溃修复能力 (crash recovery capabilities) 的事务安全 (transaction-safe (ACID compliant)) 型表。</p>
</li>
<li>是否支持外键： MyISAM 不支持，而 InnoDB 支持。</li>
<li>是否支持 MVCC：仅 InnoDB 支持。应对高并发事务 , MVCC 比单纯的加锁更高效 ;MVCC 只在 READ COMMITTED 和 REPEATABLE READ 两个隔离级别下工作 ;MVCC 可以使用乐观 (optimistic) 锁和悲观 (pessimistic) 锁来实现 ; 各数据库中 MVCC 实现并不统一</li>
</ol>
<p>来源：河北王校长</p>
<h3 id="手动用begin开启事务，然后执行update语句，再然后执行commit语句，那上面的update更新流程之前-哪些是update语句执行之后做的，哪些是commit语句执行之后做的"><a href="#手动用begin开启事务，然后执行update语句，再然后执行commit语句，那上面的update更新流程之前-哪些是update语句执行之后做的，哪些是commit语句执行之后做的" class="headerlink" title="手动用begin开启事务，然后执行update语句，再然后执行commit语句，那上面的update更新流程之前 哪些是update语句执行之后做的，哪些是commit语句执行之后做的?"></a><strong>手动用begin开启事务，然后执行update语句，再然后执行commit语句，那上面的update更新流程之前 哪些是update语句执行之后做的，哪些是commit语句执行之后做的?</strong></h3><blockquote>
<p>事实上，redo log在内存中有一个<code>redo log buffer</code>,binlog 也有一个<code>binlog cache</code>.所以在手动开启的事务中，你执行sql语句，其实是写到<code>redo log buffer</code>和<code>binlog cache</code>中去的(肯定不可能是直接写磁盘日志，一个是性能差一个是回滚的时候不可能去回滚磁盘日志吧)，然后当你执行commit的时候，首先要将redo log的提交状态由prepare改为commit状态，然后就要把<code>binlog cache</code>刷新到binlog日志(可能也只是flush到操作系统的page cache，这个就看你的mysql配置)，<code>redo log buffer</code>刷新到redo log 日志(刷新时机也是可以配置的一共有三种)。 如果你回滚的话，就只用把<code>binlog cache</code>和<code>redo log buffer</code>中的数据清除就行了。</p>
</blockquote>
<h3 id="在update过程中，mysql突然宕机，会发生什么情况"><a href="#在update过程中，mysql突然宕机，会发生什么情况" class="headerlink" title="在update过程中，mysql突然宕机，会发生什么情况?"></a>在update过程中，mysql突然宕机，会发生什么情况?</h3><ol>
<li>如果redolog写入了，处于prepare状态，binlog还没写入，那么宕机重启后，redolog中的这个事务就直接回滚了。</li>
<li>如果redolog写入了，binlog也写入了，但redolog还没有更新为commit状态，那么宕机重启以后，mysql会去检查对应事务在binlog中是否完整。如果是，就提交事务；如果不是，就回滚事务。 (redolog处于prepare状态，binlog完整启动时就提交事务，为啥要这么设计? 主要是因为binlog写入了，那么就会被从库或者用这个binlog恢复出来的库使用，为了数据一致性就采用了这个策略)，redo log和binlog是通过xid这个字段关联起来的。</li>
</ol>
<p>作者：暂停丶算不算放弃<br>链接：<a href="https://www.nowcoder.com/discuss/810539?source_id=profile_create_nctrack&amp;channel=-1" target="_blank" rel="noopener">https://www.nowcoder.com/discuss/810539?source_id=profile_create_nctrack&amp;channel=-1</a><br>来源：牛客网</p>

        </div>
        
<blockquote class="post-copyright">
    <div class="content">
        
<span class="post-time">
    Last updated: <time datetime="2022-03-17T13:09:18.599Z" itemprop="dateUpdated">2022-03-17 21:09:18</time>
</span><br>


        
        转载注明出处，原文地址：<a href="/2022/02/14/mysql-notes/" target="_blank" rel="external">https://github.com/missionOdd/2022/02/14/mysql-notes/</a>
        
    </div>
    <div class="mdui-chip" id="accost-btn">
      <span class="mdui-chip-icon mdui-color-red-a700"><i class="mdui-icon material-icons">&#xe311;</i></span>
      <span class="mdui-chip-title">Accost</span>
    </div>
    <footer>
      <div class="mdui-chip">
        <a href="https://github.com/missionOdd">
            <img src="/img/avatar.jpg" alt="Missionary">
             About Missionary
        </a>
        </div>
    </footer>
</blockquote>


        
            <div class="page-reward">
    <a id="rewardBtn" href="javascript:;" class="page-reward-btn waves-effect waves-circle waves-light">赏</a>
</div>

            
        
        <div class="post-footer">
            
	<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MYSQL/">MYSQL</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/优化/">优化</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/原理/">原理</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/技术/">技术</a></li></ul>

            <div class="page-share-wrap">
    

<div class="page-share" id="pageShare">
    <ul class="reset share-icons">
      
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://github.com/missionOdd/2022/02/14/mysql-notes/&title=《MYSQL| MYSQL优化思路+知识点梳理》 — 🎉 Missionary's Blog 😆&pic=https://github.com/missionOdd/img/avatar.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://github.com/missionOdd/2022/02/14/mysql-notes/&title=《MYSQL| MYSQL优化思路+知识点梳理》 — 🎉 Missionary's Blog 😆&source=Web后端/Java在学/单身" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      
    </ul>
 </div>



    <a href="javascript:;" id="shareFab" class="page-share-fab waves-effect waves-circle">
        <i class="icon icon-share-alt icon-lg"></i>
    </a>
</div>

        </div>
        
            <div class="mdui-container">
  <div class="mdui-tab" id="tab">
    <a href="#tab1-content" id="tab1" class="mdui-ripple">游客用户</a>
    <a href="#tab2-content" id="tab2" class="mdui-tab-active mdui-ripple">GitHub账户</a>
  </div>

  <div id="tab1-content" class="mdui-p-a-2">
    
      <div id="comment" style=""></div>

  </div>
  <div id="tab2-content" class="mdui-p-a-2">
    
          
    <div onclick="ShowGitment()" id="gitment-display-button" style="display: block;">
        <span>显示 Gitment 评论</span>
    </div>
    <div id="gitment" class="hide"></div>


    
  </div>

</div>

        
    </div>
    
<nav class="post-nav flex-row flex-justify-between">
  
    <div class="prev">
      <a href="/2022/02/15/p7-interview-skills-1/" id="post-prev" class="post-nav-link">
        <div class="tips"><i class="icon icon-angle-left icon-lg icon-pr"></i> Prev</div>
        <h4 class="title">面经 | 基础面+调优经验，高P7开发一面摘录笔记</h4>
      </a>
    </div>
  

  
    <div class="next">
      <a href="/2022/02/12/p8-interview-skills-2/" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">面经 | 结合业务，步步深入，P8架构师二面摘录笔记</h4>
      </a>
    </div>
  
</nav>


    
    
        <aside class="post-widget">
            <nav class="post-toc-wrap" id="post-toc">
                <strong>目录</strong>
                <ol class="post-toc"><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#前言"><span class="post-toc-number">1.</span> <span class="post-toc-text">前言</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#索引"><span class="post-toc-number">1.1.</span> <span class="post-toc-text">索引</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Q：什么情况索引失效？"><span class="post-toc-number">1.1.1.</span> <span class="post-toc-text">Q：什么情况索引失效？</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Mysql锁"><span class="post-toc-number">1.2.</span> <span class="post-toc-text">Mysql锁</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#MVCC概念"><span class="post-toc-number">1.2.1.</span> <span class="post-toc-text">MVCC概念</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#锁"><span class="post-toc-number">1.2.2.</span> <span class="post-toc-text">锁</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#日志系统"><span class="post-toc-number">1.3.</span> <span class="post-toc-text">日志系统</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#其他的问题"><span class="post-toc-number">1.4.</span> <span class="post-toc-text">其他的问题</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Q：执行计划？"><span class="post-toc-number">1.4.1.</span> <span class="post-toc-text">Q：执行计划？</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Q：大表怎么优化？"><span class="post-toc-number">1.4.2.</span> <span class="post-toc-text">Q：大表怎么优化？</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Q-一条语句的执行过程？"><span class="post-toc-number">1.4.3.</span> <span class="post-toc-text">Q:一条语句的执行过程？</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Q-：重做日志刷新到磁盘的策略有几种，有什么优劣？"><span class="post-toc-number">1.4.4.</span> <span class="post-toc-text">Q ：重做日志刷新到磁盘的策略有几种，有什么优劣？</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Q：purge-操作有什么作用-MySQL-篇-delete和update操作可能并不直接删除原有的数据。"><span class="post-toc-number">1.4.5.</span> <span class="post-toc-text">Q：purge 操作有什么作用 MySQL 篇 delete和update操作可能并不直接删除原有的数据。</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Q：说说主从复制的工作原理"><span class="post-toc-number">1.4.6.</span> <span class="post-toc-text">Q：说说主从复制的工作原理</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Q：主从复制bin-log-日志有几种记录方式"><span class="post-toc-number">1.4.7.</span> <span class="post-toc-text">Q：主从复制bin log 日志有几种记录方式</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Q：-主从复制有几种方式？"><span class="post-toc-number">1.4.8.</span> <span class="post-toc-text">Q： 主从复制有几种方式？</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Q：Innodb-和-mylsam-存储引擎的区别"><span class="post-toc-number">1.4.9.</span> <span class="post-toc-text">Q：Innodb 和 mylsam 存储引擎的区别</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#手动用begin开启事务，然后执行update语句，再然后执行commit语句，那上面的update更新流程之前-哪些是update语句执行之后做的，哪些是commit语句执行之后做的"><span class="post-toc-number">1.4.10.</span> <span class="post-toc-text">手动用begin开启事务，然后执行update语句，再然后执行commit语句，那上面的update更新流程之前 哪些是update语句执行之后做的，哪些是commit语句执行之后做的?</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#在update过程中，mysql突然宕机，会发生什么情况"><span class="post-toc-number">1.4.11.</span> <span class="post-toc-text">在update过程中，mysql突然宕机，会发生什么情况?</span></a></li></ol></li></ol></li></ol>
            </nav>
            <div class="toc-bar"><div>
        </aside>
    

</article>

    <div id="reward" class="page-modal reward-lay">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <h3 class="reward-title">
        <i class="icon icon-quote-left"></i>
        我们一起来让这个世界有趣一点
        <i class="icon icon-quote-right"></i>
    </h3>
    <div class="reward-content">
        
        <div class="reward-code">
            <img id="rewardCode" src="/img/reward-wechat.jpg" alt="打赏二维码">
        </div>
        
        <label class="reward-toggle">
            <input id="rewardToggle" type="checkbox" class="reward-toggle-check"
                data-wechat="/img/reward-wechat.jpg" data-alipay="/img/reward-alipay.jpg">
            <div class="reward-toggle-ctrol">
                <span class="reward-toggle-item wechat">微信</span>
                <span class="reward-toggle-label"></span>
                <span class="reward-toggle-item alipay">支付宝</span>
            </div>
        </label>
        
    </div>
</div>

    

</div>

    </main>
    <footer class="footer ">
    
    <div class="top">
        
            <p>
    <span>Links：</span>
    
    <span class="blogroll-item">
        <a href="https://github.com/missionOdd" target="_blank">HOME</a>
    </span>
    
</p>

        
    </div>
    
    <div class="mdui-bottom-nav">
  <a href="javascript:;" class="mdui-ripple mdui-bottom-nav-active">
    <i class="mdui-icon material-icons">history</i>
    <label>Recents</label>
  </a>
  <a href="javascript:;" class="mdui-ripple">
    <i class="mdui-icon material-icons">favorite</i>
    <label>Favorites</label>
  </a>
  <a href="javascript:;" class="mdui-ripple">
    <i class="mdui-icon material-icons">&#xe80e;</i>
    <label>Hot</label>
  </a>

</div>
    <div class="bottom">
        <p>
            <span>
                Missionary &copy; 2018 - 2022
            </span>
           	
           	<span>
           		<a href="http://www.miitbeian.gov.cn/" target="_blank">粤ICP备19008953号</a>
           	</span>
           	

            

            <span>
	            Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/codefine/hexo-theme-mellow" target="_blank">mellow</a>
            </span>
            

            
            <span>
	            Hosted by <a href="https://coding.net/pages" target="_blank">Coding Pages</a>
            </span>
            


        </p>
        <p>
          
              
<span class="site-uv" title="总访客量">
    <i class="icon icon-user"></i>
    <i class="busuanzi-value" id="busuanzi_value_site_uv"></i>
</span>


<span class="site-pv" title="总访问量">
    <i class="icon icon-eye"></i>
    <i class="busuanzi-value" id="busuanzi_value_site_pv"></i>
</span>


          
          <span id="timeDate">载入天数...</span><span id="times">载入时分秒...</span>
          <script>
              var now = new Date();
              function createtime() {
                  var grt= new Date("09/15/2018 12:49:00");//此处修改你的建站时间或者网站上线时间
                  now.setTime(now.getTime()+250);
                  days = (now - grt ) / 1000 / 60 / 60 / 24; dnum = Math.floor(days);
                  hours = (now - grt ) / 1000 / 60 / 60 - (24 * dnum); hnum = Math.floor(hours);
                  if(String(hnum).length ==1 ){hnum = "0" + hnum;} minutes = (now - grt ) / 1000 /60 - (24 * 60 * dnum) - (60 * hnum);
                  mnum = Math.floor(minutes); if(String(mnum).length ==1 ){mnum = "0" + mnum;}
                  seconds = (now - grt ) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum);
                  snum = Math.round(seconds); if(String(snum).length ==1 ){snum = "0" + snum;}
                  document.getElementById("timeDate").innerHTML = "本站已安全运行 "+dnum+" 天 ";
                  document.getElementById("times").innerHTML = hnum + " 小时 " + mnum + " 分 " + snum + " 秒";
              }
          setInterval("createtime()",250);
          </script>
        </p>
    </div>

</footer>

    <div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light mdui-ripple"><span class="icon icon-lg icon-chevron-up"></span></a>



<div class="global-share" id="globalShare">
    <ul class="reset share-icons">
      
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://github.com/missionOdd/2022/02/14/mysql-notes/&title=《MYSQL| MYSQL优化思路+知识点梳理》 — 🎉 Missionary's Blog 😆&pic=https://github.com/missionOdd/img/avatar.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://github.com/missionOdd/2022/02/14/mysql-notes/&title=《MYSQL| MYSQL优化思路+知识点梳理》 — 🎉 Missionary's Blog 😆&source=Web后端/Java在学/单身" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      
    </ul>
 </div>


<div class="page-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>扫一扫，分享到微信</p>
    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMYAAADGCAAAAACs8KCBAAACKUlEQVR42u3aS07EQAwFwLn/pUFihYSGPNsdRLorq0gMnVQWln+vV3x9fF3f7/Pr5wnJya87LgwMjMcyqi+R3787591fq58MAwPjNEY1yFajX/Lhfv80F++MgYGB0UrsEkYSoDEwMDDmATd/9SQoY2BgYEyK2KRkTRp2eXC/pRbHwMB4IKM3GPib+9vnGxgYGP+e0RtG5o2ztU9/+ywMDIytGb+Xl0l612MkZXCSkhYOxcDA2IKxas0r/zTVQcItCSIGBsYDGdURZjVZzJcwqm+LgYGxN2MewXoBOjlncTMOAwPjsYz5skVyTm85LF/RwMDAOIeRvHq+tpUPLBcsjWFgYGzNWNW56rXn8iSyuoiGgYGxE6Oa8K1qvVWfjoGBcSajOpLslbu9sFv4PQYGxtaMSVOs+r/l0WPxWRgYGHszqknhZEVskoBGGS4GBsZ2jLK4lcbNE83yDBYDA2Mjxmh60Fq2yJ9VXu/AwMA4hpEvpOYPy5PCfHR6EXAxMDA2YuSvOwm1k4QyKpUxMDAOYFRbbHlhmSR2vVXXQrsNAwPj4Yy8iO2lidUTqsEdAwPjBMakfM0b93nYzYM4BgbGOYxJmZosiq09ubrkgYGBsRMjCbLVpth8/at6DgYGxgmMSVu/WpoursIxMDAwWuladUiQl8EXOyMYGBgYgysZVeaf4O0IEwMDY2tGb6livmZRTR8vAi4GBsamjF77vheg87B7CwYDA+N5jE9drbwqqBhkygAAAABJRU5ErkJggg==" alt="微信分享二维码">
</div>



    
   <canvas class="fireworks" style="position: fixed;left: 0;top: 0;z-index: 1; pointer-events: none;" ></canvas>
   <script type="text/javascript" src="//cdnjs.cat.net/ajax/libs/animejs/2.2.0/anime.min.js"></script>
   <script type="text/javascript" src="/js/plugins/fireworks.js?v=1.4.4"></script>


    <!-- main-js -->
<script type="text/javascript" src="//cdnjs.cat.net/ajax/libs/jquery/2.1.0/jquery.min.js"></script>
<script type="text/javascript" src="/js/plugins/fastclick.js?v=1.4.4"></script>
<script type="text/javascript" src="/js/plugins/ios-orientationchange-fix.js?v=1.4.4"></script>
<script type="text/javascript" src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.2/dist/jquery.fancybox.min.js"></script>

<script type="text/javascript" src="//cdnjs.cat.net/ajax/libs/node-waves/0.7.4/waves.min.js"></script>

<script type="text/javascript" src="/js/method.js?v=1.4.4"></script>
<script type="text/javascript" src="/js/blog.js?v=1.4.4"></script>

<!-- third-party -->




<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?18b812f3375b09bd66be7e3a46d7cc2d";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>



<script type="text/javascript" src="/js/plugins/local_search.js?v=1.4.4"></script>
<script type="text/javascript">
	var search_path = "search.xml";
	if (search_path.length === 0) {
		search_path = "search.xml";
	}
	var path = "/" + search_path;
	searchFunc(path, "local-search-input", "local-search-result");
</script>



<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




    
        <script type="text/javascript" src="//unpkg.com/valine/dist/Valine.min.js"></script>
<script type="text/javascript" src="/js/plugins/valine.js?v=1.4.4"></script>

    
    
        <script type="text/javascript" src="/js/plugins/gitmint.browser.js?v=1.4.4"></script>
<script type="text/javascript" src="/js/plugins/gitment.js?v=1.4.4"></script>
    





    <!-- mathjax config similar to math.stackexchange -->
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
            processEscapes: true,
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="//cdnjs.cat.net/ajax/libs/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>




    <script>
    (function() {
        var OriginTitile = document.title, titleTime;
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                document.title = '等你回来！';
                clearTimeout(titleTime);
            } else {
                document.title = '(つェ⊂)欢迎!';
                titleTime = setTimeout(function() {
                    document.title = OriginTitile;
                },2000);
            }
        });
    })();
</script>




    <script type="text/javascript">
  daovoice('init', {
    app_id: "8997440a"
  });
  daovoice('update');
</script>


    <script src="//cdnjs.cat.net/ajax/libs/jquery/2.1.0/jquery.min.js"></script>
<script type="text/javascript" src="/js/custom.js?v=1.4.4"></script>
<script src="//cdnjs.loli.net/ajax/libs/mdui/0.4.1/js/mdui.min.js"></script>
<script src="//cdnjs.cat.net/ajax/libs/photoswipe/4.1.2/photoswipe.min.js"></script>
<script src="//cdnjs.cat.net/ajax/libs/photoswipe/4.1.2/photoswipe-ui-default.min.js"></script>

<script type="text/javascript">
jQuery.noConflict();     //将变量$的控制权让渡
</script>
<script type="text/javascript" color="213,0,0" opacity='0.7' zIndex="-2" count="20" src="//cdnjs.cat.net/ajax/libs/canvas-nest.js/1.0.1/canvas-nest.min.js"></script>
<!-- <script type="text/javascript">

jQuery(function($){


});
</script> -->

</body>
</html>
